<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit your page</title>
    <link rel="stylesheet" href="../dependency/amedependency/starsback/stars.css"/>
    <link rel="stylesheet" href="../editormd/css/editormd.css" />
    <link rel="stylesheet" href="../work_space/EditPage.css" />
    <link rel="stylesheet" type="text/css" href="../dependency/tooltipster-3.3.0/css/tooltipster.css" />
    <link rel="stylesheet" type="text/css" href="../dependency/amedependency/solarsystem/style.css" />
    <script type="text/javascript" src="../dependency/jquery-1.7.0.min.js"></script>
    <script type="text/javascript" src="../dependency/tooltipster-3.3.0/js/jquery.tooltipster.min.js"></script>
    <script type="text/javascript" src="../administrator/config.js"></script>
    <script type="text/javascript" src="../dependency/amedependency/follow_nav/navbar.js"></script>

</head>
<div class="background-star" style="height: 100%;">
        <div id="stars"></div>
        <div id="stars2"></div>
        <div id="stars3"></div>

</div>
<body>
<div class="main-content" id="main-content">
    <div class="navbar " id="nav">
                <h1 class="title" style="font-size: 50px; font-family: emmm; ; font-weight: bolder;">Galaxy</h1>
                <div class="container_right">
                    <svg onclick="goToHomePage()" xmlns="http://www.w3.org/2000/svg" width="60" height="30" fill="white"  class="house tooltip"  viewBox="0 0 16 16"   title="Back to home"><path fill-rule="evenodd" d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207l-5-5-5 5V13.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V7.207Z"/></svg>
                    <svg onclick="goToViewPage()" t="1745048103601" class="blog tooltip" title="Start to view" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17352" width="60" height="30"><path d="M298.666667 256a42.666667 42.666667 0 0 1 42.666666-42.666667h341.333334a42.666667 42.666667 0 0 1 42.666666 42.666667v85.333333a42.666667 42.666667 0 0 1-42.666666 42.666667H341.333333a42.666667 42.666667 0 0 1-42.666666-42.666667V256z m64 64h298.666666v-42.666667h-298.666666v42.666667z" p-id="17353" fill="#ffffff"></path><path d="M170.666667 192A106.666667 106.666667 0 0 1 277.333333 85.333333H768a106.666667 106.666667 0 0 1 106.666667 106.666667v608a32 32 0 0 1-32 32H234.666667a42.666667 42.666667 0 0 0 42.666666 42.666667h565.333334a32 32 0 0 1 0 64H277.333333A106.666667 106.666667 0 0 1 170.666667 832v-640zM234.666667 768H810.666667V192a42.666667 42.666667 0 0 0-42.666667-42.666667H277.333333a42.666667 42.666667 0 0 0-42.666666 42.666667V768z" p-id="17354" fill="#ffffff"></path></svg>
                    <svg onclick="goToEditPage()" t="1745048381731" class="write tooltip" title="Write something" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17534" width="60" height="30"><path d="M897.28 126.72a152.661333 152.661333 0 0 1 0 215.893333L386.645333 853.333333a96 96 0 0 1-42.624 24.746667l-218.282666 59.52a32 32 0 0 1-39.253334-39.296l59.52-218.282667a96 96 0 0 1 24.746667-42.624L681.386667 126.72a152.661333 152.661333 0 0 1 215.893333 0zM640 258.56L215.978667 682.666667a32 32 0 0 0-8.234667 14.208l-44.8 164.266666 164.266667-44.8A32 32 0 0 0 341.333333 808.021333L765.44 384 640 258.56z m86.613333-86.613333l-41.386666 41.386666L810.666667 338.773333l41.386666-41.386666a88.704 88.704 0 0 0-125.44-125.44z" p-id="17535" fill="#ffffff"></path></svg>
                    <svg onclick="goToSpecialPage()" t="1745048496861" class="super tooltip" title="Try special style" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17716" width="60" height="30"><path d="M767.957333 128a32 32 0 0 1 25.813334 13.056l2.346666 3.712 139.221334 257.194667 1.621333 3.968 0.512 1.706666 0.853333 4.352 0.256 4.010667a32 32 0 0 1-1.152 8.533333l-2.005333 5.333334-1.621333 2.944a32.341333 32.341333 0 0 1-3.2 4.352l2.56-3.328-1.066667 1.493333-394.666667 448.213333a30.933333 30.933333 0 0 1-12.672 9.898667l-4.181333 1.408-3.328 0.725333L512 896l-4.266667-0.256-5.034666-1.109333a30.677333 30.677333 0 0 1-7.424-3.242667l-0.384-0.298667a28.757333 28.757333 0 0 1-5.546667-4.437333l-396.373333-449.962667-1.109334-1.365333-1.706666-2.517333a31.786667 31.786667 0 0 1-4.522667-12.842667L85.333333 416l0.128-2.816 0.554667-3.797333a31.018667 31.018667 0 0 1 1.024-3.669334l0.938667-2.517333 1.194666-2.432 138.666667-256a32 32 0 0 1 23.765333-16.469333L255.957333 128h512z m-128.085333 320H383.914667l128 327.978667 127.957333-327.978667z m-324.608 0h-127.146667l228.309334 259.157333L315.264 448z m520.448 0h-127.104l-101.034667 258.986667 228.138667-258.986667z m-452.949333-256H274.986667L170.965333 384h150.357334l61.44-192z m191.146666 0h-123.946666L388.48 384h246.826667l-61.44-192z m174.933334 0h-107.733334l61.44 192h150.272l-103.936-192z" p-id="17717" fill="#ffffff"></path></svg>
                </div>

                <div class="container_left">
                    <div class="icon-container" id="myIconContainer">
                        <img src="../person_img/none.jpg" alt="可点击图标" class="icon-img">
                        <div class="expanding-sector">
                            <div class="arc arc-1" style="--arc1-radius:58px "></div>
                            <div class="arc arc-1" style="--arc1-radius:36px"></div>
                            <div id="Login-button" class="planet" style="--angle: 20deg; --radius: 55px; --size: 15px; --color:#615608; font-size: 4px; color: aliceblue;" data-iframe-src="../Login/login_page.html">
                                去登陆
                            </div>
                            <div class="planet" style="--angle: 40deg; --radius: 30px; --size: 18px; --color: #C0C0C0; font-size: 4px; color: aliceblue;"  data-iframe-src="../Login/login_page.html">
                                联系我
                            </div>
                        </div>
                    </div>
                </div>
</div>
    <div id="test-editor" >
        <textarea style="display:none;">
# 一级标题
## 二级标题
### 三级标题
    以此类推
        </textarea>
    </div>

    <div class="save-buttons">
        <button id="save-button" type="button">保存到服务器</button>
        <button id="save-html-button" type="button">保存 HTML 到本地</button>
        <button id="save-md-button" type="button">保存 Markdown 到本地</button>
        <button id="add-label-button" type="button">添加标签</button> <!-- 新增的按钮 -->
    <div id="labels-display" class="labels-display"></div>
        <label for="filename">文章名字:</label>
        <input type="text" id="filename" value="document"> </div>
    <div id="save-status"></div>
    <div id="focus-container">
            <div id="focus-element">
                <iframe id="focus-iframe" allowfullscreen></iframe>
            </div>
            <button id="close-focus-btn">×</button>
        </div>

        <!-- 标签输入弹窗 HTML -->
<div id="label-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>输入标签 (多个标签请用逗号分隔)</h2>
        <input type="text" id="label-input" placeholder="例如: 技术, 前端, JavaScript">
        <div class="modal-buttons">
            <button id="modal-confirm-button">确定</button>
            <button id="modal-cancel-button">取消</button>
        </div>
    </div>
</div>

</div>

</body>


<script src="../editormd/editormd.min.js"></script>
<script src="../dependency/amedependency/solarsystem/script.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        // Initialize Tooltips
        $('.tooltip').tooltipster();

        // --- 状态变量定义 ---
        let saveMode = 'new';
        let articleId = null;
        let articleLabels = [];
        const params = new URLSearchParams(window.location.search);
        const filename = params.get('file');
        const articleTitleParam = params.get('title');
        const articleLabelsParam = params.get('labels');
        if (articleLabelsParam) {
            articleLabels = articleLabelsParam.split(',');
        }

        // --- 封装编辑器初始化和事件绑定 ---
        function setupEditorAndListeners(initialMarkdown, mode, id) {
            if (initialMarkdown) {
                $('#test-editor textarea').val(initialMarkdown);
            }

            var editor = editormd("test-editor", {
                width: "80%",
                height: "80%",
                path: "../editormd/lib/",

                // autoHeight: true,
                htmlDecode: "style,script,iframe",
                tex: true,
                emoji: true,
                taskList: true,
                flowChart: true,
                sequenceDiagram: true,
                codeFold: true,
                saveHTMLToTextarea: true,
                searchReplace: true,
                imageUpload: true,
                imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                imageUploadURL: `${API_BASE_URL}/uploads/image`,
                onload: function() {
                    editormd.loadPlugin("../editormd/plugins/image-handle-paste/image-handle-paste", function() {
                        editor.imagePaste();
                    });
                }
            });

            // --- 辅助函数：渲染标签 ---
            function renderLabels() {
                const labelsDisplay = $('#labels-display');
                labelsDisplay.empty(); // 清空现有标签

                if (articleLabels.length === 0) {
                    labelsDisplay.text('暂无标签');
                    return;
                }

                articleLabels.forEach(label => {
                    const labelItem = $(`<span class="label-item">${label}<span class="remove-label">&times;</span></span>`);
                    labelItem.find('.remove-label').on('click', function() {
                        articleLabels = articleLabels.filter(l => l !== label);
                        renderLabels(); // 重新渲染标签
                    });
                    labelsDisplay.append(labelItem);
                });
            }

            // 初次渲染标签（加载时可能已有标签）
            renderLabels();

            // --- 为保存按钮绑定事件 ---
            $('#save-button').on('click', function() {
                var markdownContent = editor.getMarkdown();
                var htmlContent = editor.getHTML();
                var filenameBase = $('#filename').val() || 'document';

                console.log(`准备保存... 模式: ${mode}, ID: ${id}, 文件名: ${filenameBase}, 标签: ${articleLabels.join(',')}`);
                // 在这里调用 saveToServer，并传递 articleLabels
                saveToServer(markdownContent, htmlContent, filenameBase, mode, id, articleLabels);
            });

            // 其他按钮事件监听器
            $('#save-html-button').on('click', function() {
                var htmlContent = editor.getHTML();
                var filenameBase = $('#filename').val() || 'document';
                var fullHtml = `<!DOCTYPE html>\n<html>\n<head>\n<meta charset="utf-8">\n<title>${filenameBase}</title>\n</head>\n<body>\n${htmlContent}\n</body>\n</html>`;
                downloadFileLocally(fullHtml, filenameBase + '.html', 'text/html');
            });

            $('#save-md-button').on('click', function() {
                var markdownContent = editor.getMarkdown();
                var filenameBase = $('#filename').val() || 'document';
                downloadFileLocally(markdownContent, filenameBase + '.md', 'text/markdown');
            });

            // --- 标签弹窗 ---
            const labelModal = $('#label-modal');
            const addLabelButton = $('#add-label-button');
            const labelInput = $('#label-input');
            const modalConfirmButton = $('#modal-confirm-button');
            const modalCancelButton = $('#modal-cancel-button');
            const closeButton = $('.close-button');

            addLabelButton.on('click', function() {
                labelInput.val(articleLabels.join(', '));
                labelModal.css('display', 'flex');
            });

            function closeModal() {
                labelModal.css('display', 'none');
                labelInput.val('');
            }

            closeButton.on('click', closeModal);
            modalCancelButton.on('click', closeModal);

            modalConfirmButton.on('click', function() {
                const newLabelsString = labelInput.val().trim();
                if (newLabelsString) {
                    // 分割、去重、过滤空字符串
                    const newLabelsArray = newLabelsString.split(',')
                                                          .map(label => label.trim())
                                                          .filter(label => label !== '');
                    articleLabels = Array.from(new Set(newLabelsArray)); // 去重
                } else {
                    articleLabels = []; // 如果输入为空，则清空所有标签
                }
                renderLabels(); // 重新渲染标签
                closeModal();
            });

            // 点击弹窗外部关闭弹窗
            $(window).on('click', function(event) {
                if ($(event.target).is(labelModal)) {
                    closeModal();
                }
            });
        }

        // --- 根据是否存在 filename 执行不同逻辑 ---
        if (filename) {
            // **编辑模式 (fix)**
            saveMode = 'fix';
            articleId = filename.replace('.md', '');
            const mdUrl = API_BASE_URL;

            $('#filename').val(articleTitleParam);

            $.ajax({
                url: mdUrl + `/get-markdown/${filename}`,
                method: 'GET',
                dataType: 'json', // **新增：告诉jQuery期望接收一个JSON响应**
                xhrFields: { withCredentials: true },
                success: function(response) {
                    if (response && response.status === 'success') {

                        const markdownContent = response.markdown_content || '';
                        if (response.labels && Array.isArray(response.labels)) {
                            articleLabels = response.labels;
                        } else {
                            articleLabels = [];
                        }
                        setupEditorAndListeners(markdownContent, saveMode, articleId);

                    } else {
                        // 处理后端返回的已知错误
                        const errorMessage = `# 加载失败\n\n无法获取文章内容。\n服务器消息: ${response.message || '未知错误'}`;
                        setupEditorAndListeners(errorMessage, saveMode, articleId);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("获取文章内容失败:", textStatus, errorThrown);
                    const errorMessage = `# 加载失败\n\n无法获取文章内容。\n服务器返回错误: ${jqXHR.status} - ${errorThrown}`;
                    setupEditorAndListeners(errorMessage, saveMode, articleId);
                }
            });

        } else {

            console.log("进入新建模式");
            setupEditorAndListeners(null, saveMode, articleId);
        }

        getusername();
    });
</script>

</html>
